#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 book.epub"
  exit 1
fi

INPUT_EPUB="$(realpath "$1")"
BASENAME="$(basename "$INPUT_EPUB" .epub)"
OUTPUT_EPUB="$HOME/Downloads/${BASENAME}_simplified.epub"

WORKDIR="$(mktemp -d)"

cleanup() {
  rm -rf "$WORKDIR"
}
trap cleanup EXIT

# Unzip epub
unzip -q "$INPUT_EPUB" -d "$WORKDIR"

# Convert all HTML/XHTML files
find "$WORKDIR" -type f \( -iname '*.html' -o -iname '*.xhtml' \) | while read -r f; do
  opencc -i "$f" -o "$f" -c t2s
done

# Repack epub (must not include parent dir)
(
  cd "$WORKDIR"
  zip -qr "$OUTPUT_EPUB" .
)

echo "Saved to: $OUTPUT_EPUB"

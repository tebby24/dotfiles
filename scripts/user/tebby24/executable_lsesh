#!/bin/zsh

# 1. Configuration
BASE_DIR="$HOME/lsesh"
SESSION_NAME="lsesh"
COMMAND=$1

# Helper function to handle tmux attachment
attach_to_session() {
    if [[ -z "$TMUX" ]]; then
        tmux attach -t "$SESSION_NAME"
    else
        tmux switch-client -t "$SESSION_NAME"
    fi
}

# 2. Command Logic
case "$COMMAND" in
    "new")
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        TARGET_DIR="${BASE_DIR}/${TIMESTAMP}_lsesh"
        
        mkdir -p "$TARGET_DIR"

        if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            tmux new-session -ds "$SESSION_NAME" -c "$BASE_DIR"
        fi

        tmux send-keys -t "$SESSION_NAME" "cd $TARGET_DIR && clear" C-m
        attach_to_session
        ;;

    "recent")
        # Zsh globbing: 
        # (/)  -> matches directories only
        # (om) -> sorts by modification time (newest first)
        # [1]  -> takes the first result
        RECENT_DIR=($BASE_DIR/*_lsesh(/om[1]))

        if [[ -z "$RECENT_DIR" ]]; then
            echo "No recent learning sessions found in $BASE_DIR"
            exit 1
        fi

        if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            tmux new-session -ds "$SESSION_NAME" -c "$RECENT_DIR"
        else
            tmux send-keys -t "$SESSION_NAME" "cd $RECENT_DIR && clear" C-m
        fi

        attach_to_session
        ;;

    *)
        echo "Usage: lsesh {new|recent}"
        exit 1
        ;;
esac
